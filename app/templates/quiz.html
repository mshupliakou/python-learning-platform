{% extends "base.html" %}

{% block title %}{{ quiz.title }} | PyLearn{% endblock %}

{% block content %}

<style>
    .answer-option {
        background-color: rgba(255, 255, 255, 0.02);
        border: 1px solid #333;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .answer-option:hover {
        border-color: rgba(var(--accent-rgb), 0.5);
        background-color: rgba(255, 255, 255, 0.05);
    }

    .custom-radio-input {
        appearance: none;
        -webkit-appearance: none;
        margin: 0;
        width: 0;
        height: 0;
        opacity: 0;
        position: absolute;
    }

    .custom-radio-circle {
        width: 22px;
        height: 22px;
        border: 2px solid var(--accent);
        border-radius: 50%;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
        background: transparent;
    }

    .custom-radio-circle::after {
        content: '';
        width: 12px;
        height: 12px;
        background-color: var(--accent);
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.2s ease;
    }

    .custom-radio-input:checked + .custom-radio-circle::after {
        transform: scale(1);
    }

    .answer-option.selected {
        border-color: var(--accent) !important;
        background-color: rgba(var(--accent-rgb), 0.05) !important;
    }

    .answer-text {
        color: var(--text-main);
        font-size: 1rem;
        user-select: none;
    }

    .answer-option.disabled {
        opacity: 0.7;
        pointer-events: none;
    }
</style>

<div class="container mt-5 mb-5" style="max-width: 800px;">

    <div class="text-center mb-5">
        <h1 style="color: var(--accent); font-weight: bold; letter-spacing: 2px;">{{ quiz.title }}</h1>
        <p class="text-muted">Test your knowledge.</p>
    </div>

    <div id="quiz-form" role="form">
        {% for q in quiz.questions %}

        <fieldset class="card mb-4 p-4 question-card" style="background-color: var(--bg-card); border: 1px solid var(--border); border-left: 5px solid var(--accent);">

            <legend class="visually-hidden">Question {{ loop.index }}</legend>

            <div class="mb-3" style="font-size: 1.15rem; color: #fff;">
                <span class="text-muted fw-bold me-2">Q{{ loop.index }}:</span>
                {{ q.question | safe }}
            </div>

            <div class="options-list ms-3">
                {% for a in q.answers %}
                {% set is_selected = a.id_answer in user_answers_ids %}

                <label class="p-3 rounded answer-option {% if is_selected %}selected{% endif %} {% if already_taken %}disabled{% endif %}"
                       for="ans_{{ a.id_answer }}">

                    <input class="custom-radio-input" type="radio"
                           name="question_{{ q.id_question }}"
                           value="{{ a.id_answer }}"
                           id="ans_{{ a.id_answer }}"
                           {% if is_selected %}checked{% endif %}
                           {% if already_taken %}disabled{% endif %}>

                    <span class="custom-radio-circle" aria-hidden="true"></span>

                    <span class="answer-text" {% if is_selected %}style="color: var(--accent); font-weight: bold;"{% endif %}>
                        {{ a.answer }}
                    </span>
                </label>
                {% endfor %}
            </div>
        </fieldset>
        {% endfor %}

        {% if not already_taken %}
        <div class="text-center mt-5 mb-5" id="submit-btn-container">
            <button type="button" onclick="submitQuiz()" class="btn-get-started"
                    style="background-color: var(--accent); color: black; font-weight: bold; border-radius: 20px; padding: 12px 50px; border: none; font-size: 1.2rem; cursor: pointer;">
                SUBMIT ANSWERS
            </button>
        </div>
        {% endif %}

        <div id="result-box" class="alert mt-4 text-center" role="alert"
             style="background: rgba(var(--accent-rgb), 0.1); border: 1px solid var(--accent); color: #fff; {% if not already_taken %}display: none;{% endif %}">
            <h2 class="mb-4">Result: <span id="score-percent" style="color: var(--accent); font-weight: bold;">{{ percentage }}%</span></h2>

            <a href="{{ url_for('main.view_lesson', id_lesson=quiz.id_lesson) }}"
               class="btn-get-started"
               style="background-color: var(--accent); color: black; font-weight: bold; border-radius: 20px; padding: 10px 30px; text-decoration: none; display: inline-block;">
                &larr; BACK TO LESSON
            </a>
        </div>

    </div>
</div>

<script>
    async function submitQuiz() {
        const answers = {};
        const questions = document.querySelectorAll('.question-card');
        let allAnswered = true;

        questions.forEach(card => {
            const checked = card.querySelector('input[type="radio"]:checked');
            if (checked) {
                const qId = checked.name.replace('question_', '');
                answers[qId] = checked.value;
            } else {
                allAnswered = false;
            }
        });

        if (!allAnswered) {
            alert("Please answer all questions before submitting.");
            return;
        }

        if (!confirm("Are you sure? You cannot retake this quiz.")) {
            return;
        }

        try {
            const response = await fetch("{{ url_for('main.quiz', id_quiz=quiz.id_quiz) }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ answers: answers })
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById('score-percent').innerText = result.percentage + '%';
                document.getElementById('result-box').style.display = 'block';

                const submitBtn = document.getElementById('submit-btn-container');
                if (submitBtn) submitBtn.style.display = 'none';

                const inputs = document.querySelectorAll('input[type="radio"]');
                inputs.forEach(input => input.disabled = true);

                document.getElementById('result-box').scrollIntoView({ behavior: 'smooth' });

            } else {
                alert("Something went wrong. Please try again.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Network error.");
        }
    }

    document.querySelectorAll('.answer-option').forEach(label => {
        label.addEventListener('click', function(e) {
            // Zapobiega podwójnemu wyzwoleniu zdarzenia, jeśli kliknięto bezpośrednio w input
            if (e.target.tagName === 'INPUT') return;

            const radio = this.querySelector('input[type="radio"]');
            if (radio.disabled) return;

            // Manualnie zaznacz radio, jeśli kliknięto w div (label)
            radio.checked = true;

            const allInGroup = this.closest('.options-list').querySelectorAll('.answer-option');
            allInGroup.forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('.answer-text').style.color = 'var(--text-main)';
                opt.querySelector('.answer-text').style.fontWeight = 'normal';
            });

            this.classList.add('selected');
            this.querySelector('.answer-text').style.color = 'var(--accent)';
            this.querySelector('.answer-text').style.fontWeight = 'bold';
        });
    });

    // Obsługa zmiany stanu inputa (dla klawiatury i kliknięć bezpośrednich)
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
             const label = this.closest('.answer-option');
             const allInGroup = label.closest('.options-list').querySelectorAll('.answer-option');

             allInGroup.forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('.answer-text').style.color = 'var(--text-main)';
                opt.querySelector('.answer-text').style.fontWeight = 'normal';
            });

            label.classList.add('selected');
            label.querySelector('.answer-text').style.color = 'var(--accent)';
            label.querySelector('.answer-text').style.fontWeight = 'bold';
        });
    });
</script>

{% endblock %}